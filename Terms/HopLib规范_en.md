# HopLib Skill Library Specification

HopLib is the cross-task reusable skill library for the HOP project. Unlike Hoplets under Tasks/, HopLib entries are validated general-purpose capability units that can be referenced by multiple tasks through `call` steps or the `SkillRegistry` API.

> This document defines HopLib's directory conventions, signature conventions, quality thresholds, and reference methods. API details for `SkillRegistry` and `HopSkill Protocol` can be found in `hoplogic/docs/hop_skill.md`.

## Directory Conventions

```
HopLib/
  <name>/
    metainfo.md        # Metadata contract (required)
    Hop.py             # Executable skill code (required)
    SKILL.md           # AgentSkills.io interoperability description (generated by /spec2code)
    test/              # Unit test directory (required)
      __init__.py
      test_<name>.py
    TestCases/         # Batch test data (recommended)
      test_cases.jsonl
```

- `<name>` is the skill name, consistent with the `name` field in `metainfo.md` (e.g., `OCR`, `WebSearch`, `Chart`).
- `SKILL.md` is generated from `metainfo.md` using `generate_skill_md(parse_metainfo(metainfo_path))`.

## Differences from Task Hoplet

| Dimension | Task Hoplet (`Tasks/<name>/Hoplet/`) | HopLib (`HopLib/<name>/`) |
|-----------|---------------------------------------|--------------------------|
| Positioning | Task-specific business tasks | Cross-task reusable general capabilities |
| Scan Priority | Low (scanned after SkillRegistry) | High (scanned first by SkillRegistry) |
| Name Conflicts | Overridden by HopLib | Wins |
| hop_engine Dependency | Usually dependent | Independent (maintains independence) |
| source_type | `"hoplet"` | `"hoplib"` |

`SkillRegistry` scans in the order HopLib > Tasks > External, with the first discovered entry winning in case of name conflicts.

## Signature Conventions

HopLib skill functions follow this signature:

```python
async def hop_<name>(session, input_data: dict) -> tuple[str, dict]:
    """
    Args:
        session: HopSession instance (can be None when skill doesn't require LLM)
        input_data: Dictionary conforming to input contract in metainfo.md

    Returns:
        (status, result) tuple
        - status: "OK" or "FAIL" string (use module constants _OK/_FAIL)
        - result: Dictionary conforming to output contract in metainfo.md
    """
```

Key constraints:
- **Do not import hop_engine**: Use `_OK = "OK"` / `_FAIL = "FAIL"` string constants instead of `HopStatus` enum
- **HopletAdapter automatic conversion**: `_normalize_result()` will coerce string status to `HopStatus`
- **Function name must contain "hop"**: `_detect_hop_func()` searches by name, function name must contain "hop" (case-insensitive)

## Dependency Isolation

HopLib entries' dependencies must be confined to themselves, not extending to hoplogic:

- Do not import `hop_engine`, `hop_mcp`, `hop_rag`, etc. hoplogic subpackages
- When LLM capabilities are needed, use indirectly through the `session` parameter (injected by caller)
- Third-party dependencies declared in the `dependencies` section of `metainfo.md`
- Pure computational skills (e.g., Chart) can have `session` parameter as `None`

## Version Management

HopLib entries use [SemVer](https://semver.org/) version numbers, recorded in the `version` field of `metainfo.md`.

Increment rules:

| Change Type | Increment |
|-------------|-----------|
| Breaking changes to `input_contract` / `output_contract` (field deletion, type modification) | MAJOR |
| Adding optional input fields, adding output fields | MINOR |
| Bug fixes, performance optimizations, internal refactoring | PATCH |

## Quality Thresholds

| Metric | Requirement |
|--------|-------------|
| Unit test coverage | >= 99% (including branch) |
| `test/` directory | Must exist |
| `TestCases/` directory | Recommended (with `test_cases.jsonl`) |
| metainfo.md | All sections must be completely filled |
| SKILL.md | Must exist (generated by `generate_skill_md`) |

## Reference Methods

### HopSpec `call` Step Reference

In HopSpec.md, the `skill` field of `call` steps should contain the HopLib entry name:

```yaml
- step_name: extract_text
  type: call
  skill: OCR
  input_map: {image: "{image_url}"}
  output: ocr_result
```

The JIT engine's `_exec_call` resolves the skill instance through `session._skill_registry.get(name)` and calls `invoke()`.

### Python API Reference

```python
from hop_skill import SkillRegistry

reg = SkillRegistry(hoplib_root="HopLib", tasks_root="Tasks")
reg.scan()

skill = reg.get("Chart")
status, result = await skill.invoke(session, {
    "data": [{"x": "A", "y": 1}],
    "chart_type": "bar",
    "x_field": "x",
    "y_field": "y",
})
```

### CLI Reference

```bash
cd hoplogic && uv run python -m hop_skill run Chart '{"data": [{"x":"A","y":1}], "chart_type":"bar", "x_field":"x", "y_field":"y"}'
```